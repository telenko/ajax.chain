(function(e,t,n,r,i,s){function o(){n.sync=function(e,t,n){if(t.loading&&t.loading.method==e){t.loading.xhr.abort()}var r=i.ajax({context:n,contentType:"application/json",data:JSON.stringify(t.attributes),beforeSend:n.beforeSend,error:n.error,success:n.success,async:n.async,dataType:t.contentTypeResp?t.contentTypeResp:"json",cache:false,method:e?e:"POST",url:t.url,xhrFields:{withCredentials:true},complete:n.complete});t.loading={method:e,xhr:r}}}i(function(){o()});_ch={};_ch.Common={Messages:{error:"sorry, an error occured in application",handlerNotSpecified:"handler is not specified",notValidChainController:"controller must be AjaxChain",notValidAjaxController:"controller must be AjaxWidget",noUrlInAjaxConstructor:"URL parameter is null or empty",notValidChainArguments:"arguments in list must be AjaxWidget"},Ajax:{methodType:{post:"post",get:"get"},state:{pass:"PASS",process:"PROCESS",pause:"PAUSE",fail:"FAIL",wait:"WAIT",stop:"STOP"}}};_ch.Utils={getContent:function(e,t){return t?Mustache.to_html(e,t):e},addContent:function(e,t,n){i(e).html(this.getContent(t,n))},concatFunctions:function(e,t){var n=function(e){this.func1(e);this.func2()};n.func1=e;n.func2=t;return n}};_ch.Template={ajax:"<td>{{url}}</td><td>{{async}}</td>",chain:'<div class="button start"></div>'+'<div class="button pause"></div>'+'<div class="button stop"></div>'+"<table></table>"};_ch.AjaxWidget=n.View.extend({methodType:_ch.Common.Ajax.methodType.post,xhrObject:null,errorTemplate:_ch.Template.error,errorMessage:_ch.Common.Messages.error,loadAddonsIfFail:true,showDefaultError:true,async:true,delayPeriod:500,initialize:function(e,t){if(typeof e==="function"){this.onEndFunc=e}for(var n in t){this[n]=t[n]}if(!this.url){throw new Error(_ch.Common.Messages.noUrlInAjaxConstructor)}this.model=new _ch.AjaxWidget.Model;this.view=new _ch.AjaxWidget.View({controller:this});this.listenModel();this.model.wait()},beforeSend:function(){i(this.el).html(_ch.Template.loader)},success:function(e,t,n){console.log("success");var r=this;this.successTimer=setInterval(function(){if(_ch.paused){r.model.pause();return false}r.successHandler(e);clearInterval(r.successTimer);r.model.pass()},this.delayPeriod)},successHandler:function(e){console.log("successHandler");if(typeof this.onEndFunc==="function"){this.onEndFunc(e)}else{this.showError(_ch.Common.Messages.handlerNotSpecified)}if(this.async){this.addonsActions()}},prepareRequestModel:function(){this.requestModel=new n.Model;this.requestModel.attributes=this.body;this.requestModel.url=this.url},buildResponseModel:function(e){},error:function(e,t,n){var r=this;this.errorTimer=setInterval(function(){if(_ch.paused){r.model.pause();return false}r.errorHandler(e,t,n);clearInterval(r.errorTimer)},this.delayPeriod)},errorHandler:function(e,t,n){if(t==="abort"){this.abortHandler();return false}this.hideLoading();var r=this.showDefaultError?this.errorMessage:n;this.showError(r);if(this.loadAddonsIfFail&&this.async){this.addonsActions()}this.model.fail()},abortHandler:function(){console.log("abort")},clear:function(){i(this.el).empty()},getRequestModel:function(){return this.requestModel},close:function(){this.unbind();this.remove()},complete:function(){this.hideLoading()},showError:function(e){var t=this.errorSelector?this.errorSelector:this.el;_ch.Utils.addContent(t,this.errorTemplate,this.errorMessage)},load:function(){console.log("starting loading");this.prepareRequestModel();n.sync(this.methodType,this.getRequestModel(),this);this.model.process();if(!this.async){this.addonsActions()}},addonsActions:function(){},hideLoading:function(){},hideView:function(){i(this.el).hide()},abortLoading:function(){if(this.requestModel&&this.requestModel.loading){this.requestModel.loading.xhr.abort();this.model.stop()}},listenModel:function(){var e=this;this.model.on("change:state",function(){var t=this.getState();var n=e.view;if(t===_ch.Common.Ajax.state.fail){n.fail()}else if(t===_ch.Common.Ajax.state.pass){n.pass()}else if(t===_ch.Common.Ajax.state.process){n.process()}else if(t===_ch.Common.Ajax.state.pause){n.pause()}else if(t===_ch.Common.Ajax.state.stop){n.stop()}else{n.wait()}})}});_ch.AjaxWidget.View=n.View.extend({tagName:"tr",className:"ajax-view",initialize:function(e){var t=e.controller;if(!t instanceof _ch.AjaxWidget){throw new Error(_ch.Common.Messages.notValidAjaxController)}this.controller=t},template:_ch.Template.ajax,wait:function(){_ch.Utils.addContent(this.el,this.template,this.controller)},pass:function(){i(this.el).css("background-color","rgb(70, 205, 70)")},process:function(){i(this.el).css("background-color","rgb(224, 224, 57)")},pause:function(){i(this.el).css("background-color","rgb(210, 224, 230)")},fail:function(){i(this.el).css("background-color","rgb(221, 66, 66)")},stop:function(){i(this.el).css("background-color","rgb(107, 107, 107)")}});_ch.AjaxWidget.Model=n.Model.extend({defaults:{state:_ch.Common.Ajax.state.wait},wait:function(){this.setState(_ch.Common.Ajax.state.wait)},fail:function(){this.setState(_ch.Common.Ajax.state.fail)},pause:function(){this.setState(_ch.Common.Ajax.state.pause)},process:function(){this.setState(_ch.Common.Ajax.state.process)},pass:function(){this.setState(_ch.Common.Ajax.state.pass)},stop:function(){this.setState(_ch.Common.Ajax.state.stop)},getState:function(){return this.get("state")},setState:function(e){this.set("state",e)}});_ch.AjaxChain=n.View.extend({add:function(e){this.chain=this.importChain(e)},importChain:function(e){for(var t=0;t<e.length-1;t++){if(e[t]instanceof _ch.AjaxWidget){var n=function(){this.next.load()};e[t].next=e[t+1];e[t].addonsActions=n}else{throw new Error(_ch.Common.Messages.notValidChainArguments)}}return e},start:function(){this.startFrom(0)},startFrom:function(e){this.chain[e].load()},pause:function(){_ch.paused=true},resume:function(){_ch.paused=false},isPaused:function(){return _ch.paused},stop:function(){for(var e=0;e<this.chain.length;e++){if(this.chain[e].requestModel&&this.chain[e].requestModel.loading){this.chain[e].abortLoading()}}this.resume()}});_ch.AjaxChain.View=n.View.extend({className:"chain",initialize:function(e){var t=e.controller;if(!t instanceof _ch.AjaxChain){throw new Error(_ch.Common.Messages.notValidChainController)}this.controller=t},template:_ch.Template.chain,events:{"click .start":function(){if(this.controller.isPaused()){this.controller.resume()}else{this.controller.start()}},"click .stop":function(){this.controller.stop()},"click .pause":function(){this.controller.pause()}},render:function(){_ch.Utils.addContent(this.el,this.template);for(var e=0;e<this.controller.chain.length;e++){i(this.el).find("table").append(this.controller.chain[e].view.el);this.controller.chain[e].view.wait()}}})})(window,document,Backbone,jQuery,$,_)